
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Estimating Equilibrium Climate Sensitivity in CMIP6 models &#8212; CMIP6 Cookbook</title>
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-pythia-theme.min.css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/design-tabs.js"></script>
    <script src="_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="CMIP6 Cookbook" href="landing-page.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="132">
    <div class="container-fluid" id="shim"></div>
    <div class="container-fluid" id="banner"></div>
    <nav class="navbar navbar-dark navbar-expand-lg bg-dark fixed-top bd-navbar shadow" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="https://projectpythia.org">
  <img src="_static/pythia_logo-white-rtext.svg" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class=" collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
  
  <li class="nav-item">
    
    
    
    <a class="nav-link nav-internal" href="https://projectpythia.org">Home</a>
  </li>
  
  <li class="nav-item">
    
    
    
    <a class="nav-link nav-internal" href="https://foundations.projectpythia.org">Foundations</a>
  </li>
  
  <li class="nav-item">
    
    
    
    <a class="nav-link nav-internal" href="projectpythiatutorials.github.io">Cookbooks</a>
  </li>
  
  <li class="nav-item">
    
    
    
    <a class="nav-link nav-internal" href="https://projectpythia.org/resource-gallery.html">Resources</a>
  </li>
  
  <li class="nav-item">
    
    
    
    <a class="nav-link nav-internal" href="https://projectpythia.org/index.html#join-us">Community</a>
  </li>
  
  
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/ProjectPythiaTutorials" rel="noopener" target="_blank" title="GitHub">
            <span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/project_pythia" rel="noopener" target="_blank" title="Twitter">
            <span><i class="fab fa-twitter-square"></i></span>
            <label class="sr-only">Twitter</label>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://www.youtube.com/channel/UCoZPBqJal5uKpO8ZiwzavCw" rel="noopener" target="_blank" title="YouTube">
            <span><i class="fab fa-youtube-square"></i></span>
            <label class="sr-only">YouTube</label>
          </a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    <div class="container-xl">
      <div class="row">
        
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="landing-page.html">
   CMIP6 Cookbook
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Example workflows
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Estimating Equilibrium Climate Sensitivity in CMIP6 models
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Theme by <a href="https://projectpythia.org">Project Pythia</a>.<br><br>
All code in Pythia Cookbooks is licensed under Apache 2.0. All other non-code content is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons BY 4.0 (CC BY 4.0)</a>.<br><br>

</div>

</div>

        

        <main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main"><div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/ecs-cmip6.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/ProjectPythiaTutorials/cmip6-cookbook"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/ProjectPythiaTutorials/cmip6-cookbook/issues/new?title=Issue%20on%20page%20%2Fecs-cmip6.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/ProjectPythiaTutorials/cmip6-cookbook/edit/main/ecs-cmip6.ipynb"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://binder-staging.2i2c.cloud/v2/gh/ProjectPythiaTutorials/cmip6-cookbook/main?urlpath=lab/tree/ecs-cmip6.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> On this page
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#overview">
   Overview
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#prerequisites">
   Prerequisites
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#imports">
   Imports
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#compute-cluster">
   Compute Cluster
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-catalogs">
     Data catalogs
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#use-intake-esm">
   Use Intake-ESM
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#loading-data">
   Loading Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#prepare-data">
   Prepare Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#reduce-data-via-global-mean">
   Reduce Data via Global Mean
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#do-the-computation">
   Do the Computation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#calculated-derived-variables">
   Calculated Derived Variables
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#plot-timeseries">
   Plot Timeseries
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#calculate-ecs">
   Calculate ECS
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summary">
   Summary
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#whats-next">
     What’s next?
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#resources-and-references">
   Resources and references
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
          <div id="main-content" class="row">
            <div class="col-12 col-md-9 pl-md-3 pr-md-0">
              
              <div>
                
  <p><a class="reference internal" href="_images/cmip6-cookbook-thumbnail.png"><img alt="CMIP6 image" src="_images/cmip6-cookbook-thumbnail.png" style="width: 250px;" /></a></img></p>
<div class="tex2jax_ignore mathjax_ignore section" id="estimating-equilibrium-climate-sensitivity-in-cmip6-models">
<h1>Estimating Equilibrium Climate Sensitivity in CMIP6 models<a class="headerlink" href="#estimating-equilibrium-climate-sensitivity-in-cmip6-models" title="Permalink to this headline"><i class="fas fa-link"></i></a></h1>
<hr class="docutils" />
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline"><i class="fas fa-link"></i></a></h2>
<p>Equilibrium Climate Sensitivity (ECS) is defined as change in global-mean near-surface air temperature (GMST) change due to an instantaneous doubling of CO<span class="math notranslate nohighlight">\(_2\)</span> concentrations and once the coupled ocean-atmosphere-sea ice system has acheived a statistical equilibrium (i.e. at the top-of-atmosphere, incoming solar shortwave radiation is balanced by reflected solar shortwave and outgoing thermal longwave radiation).</p>
<p>This notebook uses the “<a class="reference external" href="https://agupubs.onlinelibrary.wiley.com/doi/epdf/10.1029/2003GL018747">Gregory method</a>” to approximate the ECS of CMIP6 models based on the first 150 years after an abrupt quadrupling of CO<span class="math notranslate nohighlight">\(_2\)</span>
concentrations. The Gregory method extrapolates the quasi-linear relationship between GMST and radiative imbalance at the top-of-atmosphere to estimate how much warming would occur if the system were in radiative balance at the top-of-atmosphere, which is by definition the equilibrium response. In particular, we extrapolate the linear relationship that occurs between 100 and 150 years after the abrupt quadrupling. Since the radiative forcing due to CO<span class="math notranslate nohighlight">\(_2\)</span> is a logarithmic function of the CO<span class="math notranslate nohighlight">\(_2\)</span> concentration, the GMST change from a first doubling is roughly the same as for a second doubling (to first order, we can assume feedbacks as constant), which means that the GMST change due to a quadrupling of CO<span class="math notranslate nohighlight">\(_2\)</span> is roughly <span class="math notranslate nohighlight">\(\Delta T_{4\times\mathrm{CO}_2}=2\times\mathrm{ECS}\)</span>. See also <a class="reference external" href="https://agupubs.onlinelibrary.wiley.com/doi/epdf/10.1029/2018MS001400">Mauritsen et al. 2019</a> for a detailed application of the Gregory method (with modifications) for the case of one specific CMIP6 model, the MPI-M Earth System Model.</p>
<p>For another take on applying the Gregory method to estimate ECS, see <a class="reference external" href="https://github.com/apendergrass/cmip6-ecs">Angeline Pendergrass’ code</a>.</p>
</div>
<div class="section" id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline"><i class="fas fa-link"></i></a></h2>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>Concepts</p></th>
<th class="head"><p>Importance</p></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a class="reference external" href="https://foundations.projectpythia.org/core/xarray/xarray-intro.html">Intro to Xarray</a></p></td>
<td><p>Necessary</p></td>
<td><p></p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="https://foundations.projectpythia.org/core/data-formats/netcdf-cf.html">Understanding of NetCDF</a></p></td>
<td><p>Helpful</p></td>
<td><p>Familiarity with metadata structure</p></td>
</tr>
<tr class="row-even"><td><p>Dask</p></td>
<td><p>Helpful</p></td>
<td><p></p></td>
</tr>
<tr class="row-odd"><td><p>Climate sensitivity</p></td>
<td><p>Helpful</p></td>
<td><p></p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p><strong>Time to learn</strong>: 30 minutes</p></li>
</ul>
</div>
<hr class="docutils" />
<div class="section" id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Permalink to this headline"><i class="fas fa-link"></i></a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">xesmf</span> <span class="k">as</span> <span class="nn">xe</span>
<span class="kn">import</span> <span class="nn">cartopy</span>
<span class="kn">import</span> <span class="nn">dask</span>
<span class="kn">from</span> <span class="nn">tqdm.autonotebook</span> <span class="kn">import</span> <span class="n">tqdm</span>  <span class="c1"># Fancy progress bars for our loops!</span>
<span class="kn">import</span> <span class="nn">intake</span>
<span class="kn">import</span> <span class="nn">fsspec</span>
<span class="kn">from</span> <span class="nn">dask_gateway</span> <span class="kn">import</span> <span class="n">Gateway</span>
<span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">6</span>
<span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="compute-cluster">
<h2>Compute Cluster<a class="headerlink" href="#compute-cluster" title="Permalink to this headline"><i class="fas fa-link"></i></a></h2>
<p>Here we use a dask cluster to parallelize our analysis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">platform</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span>

<span class="k">if</span> <span class="p">(</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;win32&#39;</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">multiprocessing.popen_spawn_win32</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">multiprocessing.popen_spawn_posix</span>
</pre></div>
</div>
</div>
</div>
<p>Initiate the Dask client:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>
<span class="n">client</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="data-catalogs">
<h3>Data catalogs<a class="headerlink" href="#data-catalogs" title="Permalink to this headline"><i class="fas fa-link"></i></a></h3>
<p>This notebook uses <a class="reference external" href="https://intake-esm.readthedocs.io/en/latest/"><code class="docutils literal notranslate"><span class="pre">intake-esm</span></code></a> to ingest and organize climate model output from the fresh-off-the-supercomputers Phase 6 of the Coupled Model Intercomparison Project (CMIP6).</p>
<p>The file <code class="docutils literal notranslate"><span class="pre">https://storage.googleapis.com/cmip6/cmip6-zarr-consolidated-stores.csv</span></code> in Google Cloud Storage contains thousands of lines of metadata, each describing an individual climate model experiment’s simulated data.</p>
<p>For example, the first line in the <code class="docutils literal notranslate"><span class="pre">.csv</span></code> file contains the precipitation rate (<code class="docutils literal notranslate"><span class="pre">variable_id</span> <span class="pre">=</span> <span class="pre">'pr'</span></code>), as a function of latitude, longitude, and time, in an individual climate model experiment with the BCC-ESM1 model (<code class="docutils literal notranslate"><span class="pre">source_id</span> <span class="pre">=</span> <span class="pre">'BCC-ESM1'</span></code>) developed by the Beijing Climate Center (<code class="docutils literal notranslate"><span class="pre">institution_id</span> <span class="pre">=</span> <span class="pre">'BCC'</span></code>). The model is forced by the forcing experiment SSP370 (<code class="docutils literal notranslate"><span class="pre">experiment_id</span> <span class="pre">=</span> <span class="pre">'ssp370'</span></code>), which stands for the Shared Socio-Economic Pathway 3 that results in a change in radiative forcing of <span class="math notranslate nohighlight">\(\Delta F=7.0\)</span> W m<span class="math notranslate nohighlight">\(^{-2}\)</span> from pre-industrial to 2100. This simulation was run as part of the <code class="docutils literal notranslate"><span class="pre">AerChemMIP</span></code> activity, which is a spin-off of the CMIP activity that focuses specifically on how aerosol chemistry affects climate.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;https://storage.googleapis.com/cmip6/cmip6-zarr-consolidated-stores.csv&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The file <code class="docutils literal notranslate"><span class="pre">pangeo-cmip6.json</span></code> describes the structure of the CMIP6 metadata and is formatted so as to be read in by the <code class="docutils literal notranslate"><span class="pre">intake.open_esm_datastore</span></code> method, which categorizes all of the data pointers into a tiered collection. For example, this collection contains the simulated data from 28691 individual experiments, representing 48 different models from 23 different scientific institutions. There are 190 different climate variables (e.g. sea surface temperature, sea ice concentration, atmospheric winds, dissolved organic carbon in the ocean, etc.) available for 29 different forcing experiments.</p>
</div>
</div>
<div class="section" id="use-intake-esm">
<h2>Use Intake-ESM<a class="headerlink" href="#use-intake-esm" title="Permalink to this headline"><i class="fas fa-link"></i></a></h2>
<p><a class="reference external" href="https://intake-esm.readthedocs.io/en/stable/">Intake-ESM</a> is a new package designed to make working with these data archives a bit simpler.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">col</span> <span class="o">=</span> <span class="n">intake</span><span class="o">.</span><span class="n">open_esm_datastore</span><span class="p">(</span><span class="s2">&quot;https://storage.googleapis.com/cmip6/pangeo-cmip6.json&quot;</span><span class="p">)</span>
<span class="n">col</span>
</pre></div>
</div>
</div>
</div>
<p>Here, we show the various forcing experiments that climate modellers ran in these simulations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;experiment_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="loading-data">
<h2>Loading Data<a class="headerlink" href="#loading-data" title="Permalink to this headline"><i class="fas fa-link"></i></a></h2>
<p>Intake-ESM enables loading data directly into an <code class="docutils literal notranslate"><span class="pre">xarray.DataArray</span></code>, a metadata-aware extension of numpy arrays. Xarray objects leverage <a class="reference external" href="https://www.dask.org/">Dask</a> to only read data into memory as needed for any specific operation (i.e. lazy evaluation). Think of Xarray Datasets as ways of conveniently organizing large arrays of floating point numbers (e.g. climate model data) on an n-dimensional discrete grid, with important metadata such as units, variable, names, etc.</p>
<p>Note that data on the cloud are in <a class="reference external" href="https://zarr.readthedocs.io/en/stable/">Zarr</a> format, an extension of the metadata-aware format <a class="reference external" href="https://www.unidata.ucar.edu/software/netcdf/">NetCDF</a> commonly used in the geosciences.</p>
<p>Intake-ESM has rules for aggegating datasets; these rules are defined in the collection-specification file.</p>
<p>Here, we choose the <code class="docutils literal notranslate"><span class="pre">piControl</span></code> experiment (in which CO<span class="math notranslate nohighlight">\(_2\)</span> concentrations are held fixed at a pre-industrial level of ~300 ppm) and <code class="docutils literal notranslate"><span class="pre">abrupt-4xCO2</span></code> experiment (in which CO<span class="math notranslate nohighlight">\(_2\)</span> concentrations are instantaneously quadrupled—or doubled twice—from a pre-industrial controrl state). Since the radiative forcing of CO<span class="math notranslate nohighlight">\(_2\)</span> is roughly a logarithmic function of CO<span class="math notranslate nohighlight">\(_2\)</span> concentrations, the ECS is roughly independent of the initial CO<span class="math notranslate nohighlight">\(_2\)</span> concentration. Thus, if one doubling of CO2 results in <span class="math notranslate nohighlight">\(ECS\)</span> of warming, then two doublings (or, a quadrupling) results in <span class="math notranslate nohighlight">\(2\times ECS\)</span> of warming.</p>
<p>Ideally, we would choose the <code class="docutils literal notranslate"><span class="pre">abrupt-2xCO2</span></code> forcing experiment, but more <code class="docutils literal notranslate"><span class="pre">abrupt-4xCO2</span></code> data are currently avaiable in Google Cloud Storage, making for a better example.</p>
</div>
<div class="section" id="prepare-data">
<h2>Prepare Data<a class="headerlink" href="#prepare-data" title="Permalink to this headline"><i class="fas fa-link"></i></a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">experiment_id</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;abrupt-4xCO2&#39;</span><span class="p">,</span><span class="s1">&#39;piControl&#39;</span><span class="p">],</span> <span class="c1"># pick the `abrupt-4xCO2` and `piControl` forcing experiments</span>
    <span class="n">table_id</span><span class="o">=</span><span class="s1">&#39;Amon&#39;</span><span class="p">,</span>                            <span class="c1"># choose to look at atmospheric variables (A) saved at monthly resolution (mon)</span>
    <span class="n">variable_id</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;tas&#39;</span><span class="p">,</span> <span class="s1">&#39;rsut&#39;</span><span class="p">,</span><span class="s1">&#39;rsdt&#39;</span><span class="p">,</span><span class="s1">&#39;rlut&#39;</span><span class="p">],</span>  <span class="c1"># choose to look at near-surface air temperature (tas) as our variable</span>
    <span class="n">member_id</span> <span class="o">=</span> <span class="s1">&#39;r1i1p1f1&#39;</span><span class="p">,</span>                     <span class="c1"># arbitrarily pick one realization for each model (i.e. just one set of initial conditions)</span>
<span class="p">)</span>

<span class="n">col_subset</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">require_all_on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;source_id&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">query</span><span class="p">)</span>
<span class="n">col_subset</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;source_id&quot;</span><span class="p">)[</span>
    <span class="p">[</span><span class="s2">&quot;experiment_id&quot;</span><span class="p">,</span> <span class="s2">&quot;variable_id&quot;</span><span class="p">,</span> <span class="s2">&quot;table_id&quot;</span><span class="p">]</span>
<span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The following functions help us load and homogenize the data. We use some <a class="reference external" href="https://docs.dask.org/en/latest/delayed.html"><code class="docutils literal notranslate"><span class="pre">dask.delayed</span></code></a> programming to open the datasets in parallel.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">drop_all_bounds</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Drop coordinates like &#39;time_bounds&#39; from datasets,</span>
<span class="sd">    which can lead to issues when merging.&quot;&quot;&quot;</span>
    <span class="n">drop_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">vname</span> <span class="k">for</span> <span class="n">vname</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span>
                 <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;_bounds&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">vname</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;_bnds&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">vname</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">ds</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">drop_vars</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">open_dsets</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Open datasets from cloud storage and return xarray dataset.&quot;&quot;&quot;</span>
    <span class="n">dsets</span> <span class="o">=</span> <span class="p">[</span><span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span><span class="n">fsspec</span><span class="o">.</span><span class="n">get_mapper</span><span class="p">(</span><span class="n">ds_url</span><span class="p">),</span> <span class="n">consolidated</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
             <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">drop_all_bounds</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">ds_url</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">zstore</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dsets</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;exact&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ds</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">open_delayed</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A dask.delayed wrapper around `open_dsets`.</span>
<span class="sd">    Allows us to open many datasets in parallel.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">dask</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">open_dsets</span><span class="p">)(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Create a nested dictionary of models and experiments. It will be structured like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;CESM2&#39;</span><span class="p">:</span>
  <span class="p">{</span>
    <span class="s1">&#39;piControl&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">xarray</span><span class="o">.</span><span class="n">Dataset</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="s1">&#39;abrupt-4xCO2&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">xarray</span><span class="o">.</span><span class="n">Dataset</span><span class="o">&gt;</span>
  <span class="p">},</span>
  <span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="n">dsets</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
<span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">col_subset</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;source_id&#39;</span><span class="p">,</span> <span class="s1">&#39;experiment_id&#39;</span><span class="p">]):</span>
    <span class="n">dsets</span><span class="p">[</span><span class="n">group</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">group</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">open_delayed</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Open one of the datasets directly, just to show what it looks like:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">time</span> open_dsets(df)
</pre></div>
</div>
</div>
</div>
<p>Now use dask to do this in parallel on all of the datasets:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dsets_</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">dsets</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="reduce-data-via-global-mean">
<h2>Reduce Data via Global Mean<a class="headerlink" href="#reduce-data-via-global-mean" title="Permalink to this headline"><i class="fas fa-link"></i></a></h2>
<p>We don’t want to load all of the raw model data into memory right away. Instead, we want to reduce the data by taking the global mean. We need to remember to weight this global mean by a factor proportional to <code class="docutils literal notranslate"><span class="pre">cos(lat)</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_lat_name</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Figure out what is the latitude coordinate for each dataset.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">lat_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;latitude&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">lat_name</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">lat_name</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t find a latitude coordinate&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">global_mean</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return global mean of a whole dataset.&quot;&quot;&quot;</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">get_lat_name</span><span class="p">(</span><span class="n">ds</span><span class="p">)]</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">lat</span><span class="p">))</span>
    <span class="n">weight</span> <span class="o">/=</span> <span class="n">weight</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">other_dims</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">-</span> <span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">ds</span> <span class="o">*</span> <span class="n">weight</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">other_dims</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We now apply this function, plus resampling to annual mean data, to all of the datasets. We also concatenate the experiments together into a single Dataset for each model. This is the most complex cell in the notebook. A lot is happening here.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">expts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;piControl&#39;</span><span class="p">,</span> <span class="s1">&#39;abrupt-4xCO2&#39;</span><span class="p">]</span>
<span class="n">expt_da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">expts</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="s1">&#39;experiment_id&#39;</span><span class="p">,</span>
                       <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;experiment_id&#39;</span><span class="p">:</span> <span class="n">expts</span><span class="p">})</span>

<span class="n">dsets_aligned</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dsets_</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="n">expt_dsets</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">expt_dsets</span><span class="p">]):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing experiment for </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">continue</span>

    <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">expt_dsets</span><span class="p">:</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">-</span> <span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># workaround for</span>
    <span class="c1"># https://github.com/pydata/xarray/issues/2237#issuecomment-620961663</span>
    <span class="n">dsets_ann_mean</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">expt</span><span class="p">]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">global_mean</span><span class="p">)</span>
                             <span class="o">.</span><span class="n">swap_dims</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="s1">&#39;year&#39;</span><span class="p">})</span>
                             <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
                             <span class="o">.</span><span class="n">coarsen</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                      <span class="k">for</span> <span class="n">expt</span> <span class="ow">in</span> <span class="n">expts</span><span class="p">]</span>

    <span class="c1"># align everything with the 4xCO2 experiment</span>
    <span class="n">dsets_aligned</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dsets_ann_mean</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
                                 <span class="n">dim</span><span class="o">=</span><span class="n">expt_da</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="do-the-computation">
<h2>Do the Computation<a class="headerlink" href="#do-the-computation" title="Permalink to this headline"><i class="fas fa-link"></i></a></h2>
<p>Up to this point, no computations have actually happened. Everything has been “lazy”. Now we trigger the computation to actual occur and load the global/annual mean data into memory.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dsets_aligned_</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">dsets_aligned</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Now we concatenate across models to produce one big dataset with all the required variables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">source_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dsets_aligned_</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">source_da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">source_ids</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="s1">&#39;source_id&#39;</span><span class="p">,</span>
                         <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;source_id&#39;</span><span class="p">:</span> <span class="n">source_ids</span><span class="p">})</span>

<span class="n">big_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ds</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">dsets_aligned_</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span>
                   <span class="n">dim</span><span class="o">=</span><span class="n">source_da</span><span class="p">)</span>
<span class="n">big_ds</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="calculated-derived-variables">
<h2>Calculated Derived Variables<a class="headerlink" href="#calculated-derived-variables" title="Permalink to this headline"><i class="fas fa-link"></i></a></h2>
<p>We need to calculate the net radiative imbalance, plus the anomaly of the abrupt 4xCO2 run compared to the piControl run.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">big_ds</span><span class="p">[</span><span class="s1">&#39;imbalance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">big_ds</span><span class="p">[</span><span class="s1">&#39;rsdt&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">big_ds</span><span class="p">[</span><span class="s1">&#39;rsut&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">big_ds</span><span class="p">[</span><span class="s1">&#39;rlut&#39;</span><span class="p">]</span>

<span class="n">ds_mean</span> <span class="o">=</span> <span class="n">big_ds</span><span class="p">[[</span><span class="s1">&#39;tas&#39;</span><span class="p">,</span> <span class="s1">&#39;imbalance&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">experiment_id</span><span class="o">=</span><span class="s1">&#39;piControl&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">)</span>
<span class="n">ds_anom</span> <span class="o">=</span> <span class="n">big_ds</span><span class="p">[[</span><span class="s1">&#39;tas&#39;</span><span class="p">,</span> <span class="s1">&#39;imbalance&#39;</span><span class="p">]]</span> <span class="o">-</span> <span class="n">ds_mean</span>

<span class="c1"># add some metadata</span>
<span class="n">ds_anom</span><span class="o">.</span><span class="n">tas</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Global Mean Surface Temp Anom&#39;</span>
<span class="n">ds_anom</span><span class="o">.</span><span class="n">tas</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;K&#39;</span>
<span class="n">ds_anom</span><span class="o">.</span><span class="n">imbalance</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Global Mean Radiative Imbalance&#39;</span>
<span class="n">ds_anom</span><span class="o">.</span><span class="n">imbalance</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;W m$^{-2}$&#39;</span>

<span class="n">ds_anom</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="plot-timeseries">
<h2>Plot Timeseries<a class="headerlink" href="#plot-timeseries" title="Permalink to this headline"><i class="fas fa-link"></i></a></h2>
<p>Here we plot the global mean surface temperature for each model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds_anom</span><span class="o">.</span><span class="n">tas</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">col</span><span class="o">=</span><span class="s1">&#39;source_id&#39;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="n">col_wrap</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can see that the models cover different time intervals. Let’s limit the rest of our analysis to the first 150 years.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">first_150_years</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">149</span><span class="p">)</span>
<span class="n">ds_anom</span><span class="o">.</span><span class="n">tas</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">first_150_years</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">col</span><span class="o">=</span><span class="s1">&#39;source_id&#39;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="n">col_wrap</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Same thing for radiative imbalance:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds_anom</span><span class="o">.</span><span class="n">imbalance</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">first_150_years</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">col</span><span class="o">=</span><span class="s1">&#39;source_id&#39;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="n">col_wrap</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="calculate-ecs">
<h2>Calculate ECS<a class="headerlink" href="#calculate-ecs" title="Permalink to this headline"><i class="fas fa-link"></i></a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds_abrupt</span> <span class="o">=</span> <span class="n">ds_anom</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">first_150_years</span><span class="p">,</span> <span class="n">experiment_id</span><span class="o">=</span><span class="s1">&#39;abrupt-4xCO2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">calc_ecs</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
    <span class="c1"># Some sources don&#39;t have all 150 years, drop those missing values.</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">tas</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">),</span>
                      <span class="n">ds</span><span class="o">.</span><span class="n">imbalance</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ecs</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">b</span><span class="o">/</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">ecs</span><span class="p">)</span>

<span class="n">ds_abrupt</span><span class="p">[</span><span class="s1">&#39;ecs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_abrupt</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;source_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">calc_ecs</span><span class="p">)</span>
<span class="n">ds_abrupt</span>
</pre></div>
</div>
</div>
</div>
<p>Reproduce a plot similar to <a class="reference external" href="https://twitter.com/mzelinka/status/1255534531144085513">Mark Zelinka’s</a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fg</span> <span class="o">=</span> <span class="n">ds_abrupt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;tas&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;imbalance&#39;</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s1">&#39;source_id&#39;</span><span class="p">,</span> <span class="n">col_wrap</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">calc_and_plot_ecs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">)]</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ecs</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">b</span><span class="o">/</span><span class="n">a</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">autoscale</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">]),</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;ECS = </span><span class="si">{</span><span class="n">ecs</span><span class="si">:</span><span class="s1">3.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">})</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

<span class="n">fg</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">calc_and_plot_ecs</span><span class="p">,</span> <span class="s1">&#39;tas&#39;</span><span class="p">,</span> <span class="s1">&#39;imbalance&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds_abrupt</span><span class="o">.</span><span class="n">ecs</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">hist</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds_abrupt</span><span class="o">.</span><span class="n">ecs</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;ecs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline"><i class="fas fa-link"></i></a></h2>
<p>Add one final <code class="docutils literal notranslate"><span class="pre">---</span></code> marking the end of your body of content, and then conclude with a brief single paragraph summarizing at a high level the key pieces that were learned and how they tied to your objectives. Look to reiterate what the most important takeaways were.</p>
<div class="section" id="whats-next">
<h3>What’s next?<a class="headerlink" href="#whats-next" title="Permalink to this headline"><i class="fas fa-link"></i></a></h3>
<p>Let Jupyter book tie this to the next (sequential) piece of content that people could move on to down below and in the sidebar. However, if this page uniquely enables your reader to tackle other nonsequential concepts throughout this book, or even external content, link to it here!</p>
</div>
</div>
<div class="section" id="resources-and-references">
<h2>Resources and references<a class="headerlink" href="#resources-and-references" title="Permalink to this headline"><i class="fas fa-link"></i></a></h2>
<ul class="simple">
<li><p><a class="reference external" href="http://gallery.pangeo.io/repos/pangeo-gallery/cmip6/ECS_Gregory_method.html">Original notebook in the Pangeo Gallery</a> by <a class="reference external" href="https://eapsweb.mit.edu/people/hdrake">Henri Drake</a> and <a class="reference external" href="https://ocean-transport.github.io/">Ryan Abernathey</a></p></li>
</ul>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="landing-page.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">CMIP6 Cookbook</p>
        </div>
    </a>
</div>
            </div>
          </div>
        </main>

      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

<footer class="footer">
  <div class="container-fluid m-0 p-0">
  
    <div class="footer-item">
    
  <div class="container-fluid footer-logos">
    <div class="container-xl">
      <div class="row d-flex flex-wrap align-items-center">
        <div class="d-flex col-lg-3 col-md-4 col-sm-6 p-2 mx-auto">
          <img alt="NCAR" src="_images/NCAR-contemp-logo-blue.svg" style="width: 100%">
        </div>
        <div class="d-flex col-lg-3 col-md-4 col-sm-6 p-2 mx-auto">
          <img alt="Unidata" src="_images/Unidata_logo_horizontal_1200x300.svg" style="width: 100%">
        </div>
        <div class="d-flex col-lg-3 col-md-4 col-sm-6 p-2 mx-auto">
          <img alt="UAlbany" src="_images/UAlbany-A2-logo-purple-gold.svg" style="width: 100%">
        </div>
      </div>
    </div>
  </div>
    </div>
  
    <div class="footer-item">
    
    </div>
  
    <div class="footer-item">
      <div class="container-fluid footer-info">
    <div class="container-xl">
      <div class="d-flex justify-content-center">
        <p class="py-1 m-0">
            &copy;&nbsp;2022.
        
          By the <a href="https://projectpythia.org/">Project Pythia</a> Community.
        
          Last updated on 28 June 2022.
        </p>
      </div>
    </div>
  </div>
    </div>
  
    <div class="footer-item">
    
    </div>
  
  </div>
</footer>
  </body>
</html>